<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Thought Processor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            border: 1px solid rgba(138, 43, 226, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            color: #a0a0a0;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(138, 43, 226, 0.3);
            border-color: rgba(138, 43, 226, 0.6);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        
        .stat-subtitle {
            font-size: 0.85rem;
            color: #808080;
        }
        
        .strength-meter {
            margin-top: 15px;
        }
        
        .meter-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            border-radius: 10px;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(138, 43, 226, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: rgba(138, 43, 226, 0.6);
            box-shadow: 0 10px 30px rgba(138, 43, 226, 0.2);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #a0a0a0;
            font-weight: 500;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        textarea, input {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 10px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        textarea:focus, input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        textarea::placeholder, input::placeholder {
            color: #606060;
        }
        
        button {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            margin-top: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 14px;
            border: 1px solid;
        }
        
        .status.success {
            background: rgba(52, 168, 83, 0.2);
            border-color: #34a853;
            color: #4ade80;
        }
        
        .status.error {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
            color: #f87171;
        }
        
        .status.info {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            color: #93c5fd;
        }
        
        .filters {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        select {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 10px;
            color: #e0e0e0;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }
        
        select option {
            background: #1a1a2e;
            color: #e0e0e0;
        }
        
        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
            width: auto;
        }
        
        .thoughts-list {
            grid-column: 1 / -1;
        }
        
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .view-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 10px;
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            width: auto;
        }
        
        .view-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .thoughts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .thoughts-timeline {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .thought-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            border: 1px solid rgba(138, 43, 226, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        
        .thought-item:hover {
            transform: translateX(5px);
            border-color: rgba(138, 43, 226, 0.6);
            box-shadow: 0 5px 20px rgba(138, 43, 226, 0.3);
        }
        
        .thought-item.completed {
            border-left-color: #34a853;
        }
        
        .thought-item.pending {
            border-left-color: #fbbf24;
        }
        
        .thought-item.processing {
            border-left-color: #3b82f6;
        }
        
        .thought-item.failed {
            border-left-color: #dc3545;
        }
        
        .thought-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .thought-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .thought-status.completed {
            background: rgba(52, 168, 83, 0.2);
            color: #4ade80;
            border: 1px solid #34a853;
        }
        
        .thought-status.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        
        .thought-status.processing {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid #3b82f6;
        }
        
        .thought-status.failed {
            background: rgba(220, 53, 69, 0.2);
            color: #f87171;
            border: 1px solid #dc3545;
        }
        
        .thought-text {
            color: #e0e0e0;
            margin-bottom: 12px;
            line-height: 1.6;
            font-size: 15px;
        }
        
        .thought-details {
            font-size: 12px;
            color: #808080;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .thought-meta {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .priority-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .priority-critical {
            background: rgba(220, 53, 69, 0.2);
            color: #f87171;
            border: 1px solid #dc3545;
        }
        
        .priority-high {
            background: rgba(249, 115, 22, 0.2);
            color: #fb923c;
            border: 1px solid #f97316;
        }
        
        .priority-medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }
        
        .priority-low {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid #6b7280;
        }
        
        .value-score {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.4);
            font-size: 11px;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #808080;
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #808080;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h1 style="margin: 0;">üß† AI Thought Processor</h1>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <span id="userEmail" style="color: #a0a0a0; font-size: 0.9rem;"></span>
                    <button onclick="logout()" style="padding: 8px 20px; width: auto; font-size: 14px; background: rgba(220, 53, 69, 0.2); border: 1px solid #dc3545; color: #f87171;">
                        Logout
                    </button>
                </div>
            </div>
            <p>Capture, Analyze, and Transform Your Ideas with Multi-Agent Intelligence</p>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="stat-card">
                <div class="stat-label">üßò Anxiety Level</div>
                <div class="stat-value" id="anxietyLevel">0</div>
                <div class="stat-subtitle" id="anxietySubtitle">Calm & Stable</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">‚ö†Ô∏è Critical Thoughts</div>
                <div class="stat-value" id="criticalCount">0</div>
                <div class="stat-subtitle">Last: <span id="lastCritical">None</span></div>
            </div>

            <div class="stat-card">
                <div class="stat-label">üí≠ Mental Clarity</div>
                <div class="stat-value" id="clarityScore">0%</div>
                <div class="stat-subtitle" id="nonEssentialCount">Essential thoughts</div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 20px;">
            <h2>‚ú® Submit New Thought</h2>
            <div class="form-group">
                <textarea id="thoughtText" placeholder="Share your idea, question, or insight..." style="min-height: 100px;"></textarea>
            </div>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button onclick="submitThought()" style="flex: 1; min-width: 200px;">Submit Thought</button>
                <span id="pendingBadge" style="display: none; padding: 8px 16px; background: rgba(251, 191, 36, 0.2); border: 1px solid #fbbf24; border-radius: 20px; color: #fbbf24; font-size: 14px; font-weight: 600;">
                    <span id="pendingCount">0</span> Pending
                </span>
                <button onclick="triggerProcess()" class="btn-secondary" style="min-width: 180px;">‚ö° Process All</button>
            </div>
            <div id="submitStatus"></div>
            <div id="processStatus"></div>
        </div>

        <div class="filters">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="all">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Priority</label>
                    <select id="filterPriority" onchange="applyFilters()">
                        <option value="all">All Priorities</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Category</label>
                    <select id="filterCategory" onchange="applyFilters()">
                        <option value="all">All Categories</option>
                        <option value="idea">Idea</option>
                        <option value="question">Question</option>
                        <option value="concern">Concern</option>
                        <option value="observation">Observation</option>
                        <option value="reflection">Reflection</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="sortBy" onchange="applyFilters()">
                        <option value="created_desc">Newest First</option>
                        <option value="created_asc">Oldest First</option>
                        <option value="priority_desc">Priority (High-Low)</option>
                        <option value="value_desc">Value (High-Low)</option>
                        <option value="strength_desc">Strength (High-Low)</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <button class="btn-small" onclick="resetFilters()">Reset Filters</button>
                </div>
            </div>
        </div>

        <div class="card thoughts-list">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                <h2>üìä All Thoughts (<span id="thoughtCount">0</span>)</h2>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="setViewMode('list')">üìã List View</button>
                    <button class="view-btn" onclick="setViewMode('grid')">‚äû Grid View</button>
                </div>
            </div>
            <div id="thoughtsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading thoughts...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let allThoughts = [];
        let currentViewMode = 'list';
        let isAnonymous = false;
        let anonymousSessionInfo = null;
        let eventSource = null;
        let reconnectTimeout = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // Check if user is authenticated (or allow anonymous mode)
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const userId = localStorage.getItem('user_id');
            
            if (!token || !userId) {
                // Allow anonymous mode
                isAnonymous = true;
                setupAnonymousMode();
                return true; // Allow to continue
            }
            isAnonymous = false;
            return true;
        }

        // Setup anonymous user mode
        function setupAnonymousMode() {
            // Get or create anonymous session token
            let sessionToken = localStorage.getItem('anonymous_session_token');
            if (!sessionToken) {
                // Will be created on first thought submission
                console.log('Anonymous mode: No session token yet');
            }
            
            // Update UI for anonymous user
            const userEmailElement = document.getElementById('userEmail');
            if (userEmailElement) {
                userEmailElement.textContent = 'Anonymous User (3 free thoughts)';
                userEmailElement.style.color = '#fbbf24';
            }
            
            // Show anonymous banner
            showAnonymousBanner();
        }

        // Show banner for anonymous users
        function showAnonymousBanner() {
            const banner = document.createElement('div');
            banner.id = 'anonymousBanner';
            banner.style.cssText = `
                background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
                border: 1px solid rgba(251, 191, 36, 0.5);
                border-radius: 10px;
                padding: 15px 20px;
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                backdrop-filter: blur(10px);
            `;
            
            const textSpan = document.createElement('span');
            textSpan.id = 'anonymousBannerText';
            textSpan.textContent = 'üí≠ Try 3 thoughts for free! No signup required.';
            textSpan.style.color = '#e0e0e0';
            
            const signupBtn = document.createElement('button');
            signupBtn.textContent = 'Sign Up for More';
            signupBtn.style.cssText = `
                background: linear-gradient(135deg, #667eea, #764ba2);
                border: none;
                color: white;
                padding: 8px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
            `;
            signupBtn.onmouseover = function() { this.style.transform = 'translateY(-2px)'; };
            signupBtn.onmouseout = function() { this.style.transform = 'translateY(0)'; };
            signupBtn.onclick = function() { window.location.href = 'login.html?signup=true'; };
            
            banner.appendChild(textSpan);
            banner.appendChild(signupBtn);
            
            const container = document.querySelector('.container');
            const header = document.querySelector('.header');
            container.insertBefore(banner, header.nextSibling);
        }

        // Update anonymous banner with remaining thoughts
        function updateAnonymousBanner(sessionInfo) {
            const bannerText = document.getElementById('anonymousBannerText');
            if (bannerText && sessionInfo) {
                const remaining = sessionInfo.thoughts_remaining;
                if (remaining === 0) {
                    bannerText.textContent = 'üéâ You\'ve used all 3 free thoughts! Sign up to continue.';
                    bannerText.style.color = '#fbbf24';
                } else {
                    bannerText.textContent = `üí≠ ${remaining} free thought${remaining !== 1 ? 's' : ''} remaining. Sign up for unlimited!`;
                }
            }
        }

        // Show rate limit modal when limit is reached
        function showRateLimitModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(10px);
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #1a1a2e, #16213e);
                border: 2px solid rgba(138, 43, 226, 0.5);
                border-radius: 20px;
                padding: 40px;
                max-width: 500px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(138, 43, 226, 0.4);
            `;
            
            modalContent.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 20px;">üéØ</div>
                <h2 style="color: #f093fb; margin-bottom: 15px; font-size: 2rem;">Ready for More Insights?</h2>
                <p style="color: #e0e0e0; margin-bottom: 25px; font-size: 1.1rem; line-height: 1.6;">
                    You've reached your limit of 3 free thoughts.<br>
                    Sign up now to unlock unlimited thought processing and AI-powered insights!
                </p>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                    <button id="signupBtn" style="
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        border: none;
                        color: white;
                        padding: 15px 30px;
                        border-radius: 10px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 1rem;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    ">Sign Up Free</button>
                    <button id="loginBtn" style="
                        background: transparent;
                        border: 2px solid rgba(138, 43, 226, 0.5);
                        color: #e0e0e0;
                        padding: 15px 30px;
                        border-radius: 10px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 1rem;
                        transition: all 0.3s ease;
                    ">I Have an Account</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            document.getElementById('signupBtn').onclick = function() {
                const sessionToken = localStorage.getItem('anonymous_session_token');
                localStorage.setItem('pending_conversion_token', sessionToken);
                window.location.href = 'login.html?signup=true';
            };
            
            document.getElementById('loginBtn').onclick = function() {
                const sessionToken = localStorage.getItem('anonymous_session_token');
                localStorage.setItem('pending_conversion_token', sessionToken);
                window.location.href = 'login.html';
            };
            
            // Hover effects
            const signupBtn = document.getElementById('signupBtn');
            signupBtn.onmouseover = function() { this.style.transform = 'translateY(-3px)'; };
            signupBtn.onmouseout = function() { this.style.transform = 'translateY(0)'; };
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.onmouseover = function() { this.style.transform = 'translateY(-3px)'; this.style.borderColor = '#764ba2'; };
            loginBtn.onmouseout = function() { this.style.transform = 'translateY(0)'; this.style.borderColor = 'rgba(138, 43, 226, 0.5)'; };
        }

        // Get authentication headers
        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // Get or create user ID from localStorage
        function getUserId() {
            let userId = localStorage.getItem('user_id') || localStorage.getItem('thought_user_id');
            if (!userId && !isAnonymous) {
                // If no user ID and not anonymous, redirect to login
                window.location.href = 'login.html';
                return null;
            }
            return userId;
        }

        // Handle logout
        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_email');
            localStorage.removeItem('thought_user_id');
            window.location.href = 'login.html';
        }

        // Check authentication on page load
        if (!checkAuth()) {
            // Will setup anonymous mode or stay as authenticated
        } else {
            // Display user email if authenticated
            if (!isAnonymous) {
                const userEmail = localStorage.getItem('user_email');
                if (userEmail) {
                    document.getElementById('userEmail').textContent = userEmail;
                }
            }
        }

        async function submitThought() {
            const thoughtText = document.getElementById('thoughtText').value;
            const statusDiv = document.getElementById('submitStatus');

            if (!thoughtText || !thoughtText.trim()) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Please enter a thought';
                return;
            }

            try {
                if (isAnonymous) {
                    // Anonymous submission
                    const sessionToken = localStorage.getItem('anonymous_session_token');
                    
                    const response = await fetch(`${API_BASE}/anonymous/thoughts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            text: thoughtText,
                            session_token: sessionToken 
                        })
                    });

                    if (response.status === 429) {
                        // Rate limit reached
                        statusDiv.className = 'status error';
                        statusDiv.textContent = 'üöÄ You\'ve reached your limit! Sign up to continue.';
                        showRateLimitModal();
                        return;
                    }

                    if (response.ok) {
                        const data = await response.json();
                        
                        // Store session token if new
                        if (data.session_info && data.session_info.session_token) {
                            localStorage.setItem('anonymous_session_token', data.session_info.session_token);
                            anonymousSessionInfo = data.session_info;
                            updateAnonymousBanner(data.session_info);
                        }
                        
                        statusDiv.className = 'status success';
                        const remaining = data.session_info?.thoughts_remaining || 0;
                        statusDiv.textContent = `‚úÖ Thought submitted! ${remaining} free thought${remaining !== 1 ? 's' : ''} remaining.`;
                        document.getElementById('thoughtText').value = '';
                        setTimeout(() => loadThoughts(), 1000);
                        
                        // Show modal if this was the last thought
                        if (remaining === 0) {
                            setTimeout(() => showRateLimitModal(), 2000);
                        }
                    } else {
                        throw new Error('Failed to submit');
                    }
                } else {
                    // Authenticated submission
                    const userId = getUserId();
                    if (!userId) return;

                    const response = await fetch(`${API_BASE}/thoughts`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({ user_id: userId, text: thoughtText })
                    });

                    if (response.status === 401) {
                        // Token expired or invalid
                        logout();
                        return;
                    }

                    if (response.ok) {
                        statusDiv.className = 'status success';
                        statusDiv.textContent = '‚úÖ Thought submitted successfully!';
                        document.getElementById('thoughtText').value = '';
                        setTimeout(() => loadThoughts(), 1000);
                    } else {
                        throw new Error('Failed to submit');
                    }
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Failed to submit thought. Please try again.';
            }
        }

        async function triggerProcess() {
            const statusDiv = document.getElementById('processStatus');
            statusDiv.className = 'status info';
            statusDiv.textContent = '‚öôÔ∏è Triggering batch processor...';

            try {
                const response = await fetch(`${API_BASE}/process/trigger`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (response.ok) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Processing started! Thoughts will be analyzed in the next batch cycle.';
                    setTimeout(() => loadThoughts(), 2000);
                } else {
                    throw new Error('Failed to trigger');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Failed to trigger processing.';
            }
        }

        async function loadThoughts() {
            try {
                let response;
                
                if (isAnonymous) {
                    // Load anonymous thoughts
                    const sessionToken = localStorage.getItem('anonymous_session_token');
                    if (!sessionToken) {
                        // No session yet, show empty state
                        allThoughts = [];
                        updateDashboard();
                        applyFilters();
                        return;
                    }
                    
                    response = await fetch(`${API_BASE}/anonymous/thoughts/${sessionToken}`, {
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        allThoughts = [];
                        updateDashboard();
                        applyFilters();
                        return;
                    }
                } else {
                    // Load authenticated user thoughts
                    const userId = getUserId();
                    if (!userId) return;

                    response = await fetch(`${API_BASE}/thoughts/${userId}`, {
                        headers: getAuthHeaders()
                    });

                    if (response.status === 401) {
                        logout();
                        return;
                    }
                }

                const data = await response.json();
                allThoughts = data.thoughts || [];
                
                updateDashboard();
                applyFilters();
            } catch (error) {
                console.error('Error loading thoughts:', error);
                document.getElementById('thoughtsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>Failed to load thoughts. Please check your connection.</p>
                    </div>
                `;
            }
        }

        function updateDashboard() {
            const completed = allThoughts.filter(t => t.status === 'completed');
            const pending = allThoughts.filter(t => t.status === 'pending');

            // Calculate Anxiety Level
            const anxietyKeywords = ['stress', 'worry', 'anxious', 'nervous', 'overwhelm', 'panic', 'fear'];
            const anxiousThoughts = completed.filter(t => {
                const urgency = t.classification?.urgency || '';
                const tone = t.classification?.emotional_tone || '';
                const isHighUrgency = urgency === 'high' || urgency === 'immediate';
                const isAnxiousTone = anxietyKeywords.some(kw => tone.toLowerCase().includes(kw));
                return isHighUrgency || isAnxiousTone;
            });
            const anxietyLevel = anxiousThoughts.length;
            const anxietyColor = anxietyLevel === 0 ? '#34a853' : anxietyLevel <= 2 ? '#fbbf24' : '#dc3545';

            // Calculate Critical Thoughts
            const criticalThoughts = allThoughts.filter(t => {
                const priorityLevel = t.priority?.priority_level?.toLowerCase() || '';
                return priorityLevel === 'critical' || priorityLevel === 'high';
            });
            const criticalCount = criticalThoughts.length;
            const lastCritical = criticalThoughts.length > 0
                ? new Date(criticalThoughts[0].created_at).toLocaleDateString()
                : 'None';

            // Calculate Mental Clarity Score (% of essential thoughts)
            const nonEssentialThoughts = completed.filter(t => {
                const priorityLevel = t.priority?.priority_level?.toLowerCase() || '';
                const type = t.classification?.type || '';
                const urgency = t.classification?.urgency || '';
                const weightedTotal = t.value_impact?.weighted_total || 0;

                return priorityLevel === 'defer' ||
                       (type === 'observation' && urgency === 'never') ||
                       weightedTotal === 0;
            });
            const essentialPercentage = completed.length > 0
                ? Math.round(((completed.length - nonEssentialThoughts.length) / completed.length) * 100)
                : 0;

            // Update DOM
            document.getElementById('anxietyLevel').textContent = anxietyLevel;
            document.getElementById('anxietyLevel').style.color = anxietyColor;
            document.getElementById('anxietySubtitle').textContent = anxietyLevel === 0 ? 'Calm & Stable' :
                anxietyLevel <= 2 ? 'Mild Concerns' : 'Needs Attention';

            document.getElementById('criticalCount').textContent = criticalCount;
            document.getElementById('lastCritical').textContent = lastCritical;

            document.getElementById('clarityScore').textContent = essentialPercentage + '%';
            document.getElementById('nonEssentialCount').textContent = nonEssentialThoughts.length + ' filtered out';

            // Update pending count badge
            document.getElementById('pendingCount').textContent = pending.length;
            document.getElementById('pendingBadge').style.display = pending.length > 0 ? 'inline-block' : 'none';
        }

        function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const priority = document.getElementById('filterPriority').value;
            const category = document.getElementById('filterCategory').value;
            const sortBy = document.getElementById('sortBy').value;
            
            let filtered = [...allThoughts];
            
            if (status !== 'all') {
                filtered = filtered.filter(t => t.status === status);
            }
            if (priority !== 'all') {
                filtered = filtered.filter(t => {
                    const priorityLevel = t.priority?.priority_level?.toLowerCase() || '';
                    return priorityLevel === priority.toLowerCase();
                });
            }
            if (category !== 'all') {
                filtered = filtered.filter(t => t.classification?.type === category);
            }

            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'created_desc':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'created_asc':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'priority_desc':
                        const priOrder = { critical: 4, high: 3, medium: 2, low: 1, defer: 0 };
                        const aPri = (a.priority?.priority_level?.toLowerCase() || 'defer');
                        const bPri = (b.priority?.priority_level?.toLowerCase() || 'defer');
                        return (priOrder[bPri] || 0) - (priOrder[aPri] || 0);
                    case 'value_desc':
                        return (b.analysis?.value_score || 0) - (a.analysis?.value_score || 0);
                    case 'strength_desc':
                        return (b.analysis?.strength_score || 0) - (a.analysis?.strength_score || 0);
                    default:
                        return 0;
                }
            });
            
            displayThoughts(filtered);
        }

        function resetFilters() {
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterPriority').value = 'all';
            document.getElementById('filterCategory').value = 'all';
            document.getElementById('sortBy').value = 'created_desc';
            applyFilters();
        }

        function setViewMode(mode) {
            currentViewMode = mode;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            applyFilters();
        }

        function displayThoughts(thoughts) {
            const container = document.getElementById('thoughtsList');
            document.getElementById('thoughtCount').textContent = thoughts.length;
            
            if (thoughts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí≠</div>
                        <p>No thoughts found matching your filters.</p>
                        <p style="margin-top: 10px; font-size: 14px;">Try adjusting your filters or submit a new thought!</p>
                    </div>
                `;
                return;
            }
            
            const containerClass = currentViewMode === 'grid' ? 'thoughts-grid' : 'thoughts-timeline';
            container.className = containerClass;
            
            container.innerHTML = thoughts.map(thought => {
                const analysis = thought.analysis || {};
                const classification = thought.classification || {};
                const priorityLevel = (thought.priority?.priority_level || '').toLowerCase();
                const valueScore = analysis.value_score || 0;
                const strengthScore = analysis.strength_score || 0;

                return `
                    <div class="thought-item ${thought.status}" onclick="viewDetails('${thought.user_id}', '${thought.id}')">
                        <div class="thought-header">
                            <span class="thought-status ${thought.status}">${thought.status}</span>
                            ${priorityLevel ? `<span class="priority-badge priority-${priorityLevel}">${priorityLevel}</span>` : ''}
                        </div>
                        <div class="thought-text">${thought.text}</div>
                        <div class="thought-details">
                            <div class="thought-meta">
                                <span>üìÖ ${new Date(thought.created_at).toLocaleDateString()}</span>
                            </div>
                            ${classification.type ? `
                                <div class="thought-meta">
                                    <span>üè∑Ô∏è ${classification.type}</span>
                                </div>
                            ` : ''}
                            ${valueScore > 0 ? `
                                <div class="value-score">
                                    üíé Value: ${valueScore}/10
                                </div>
                            ` : ''}
                            ${strengthScore > 0 ? `
                                <div class="value-score">
                                    ‚ö° Strength: ${strengthScore}/10
                                </div>
                            ` : ''}
                        </div>
                        ${thought.status === 'completed' && analysis.action_plan ? `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(138, 43, 226, 0.2);">
                                <div style="font-size: 12px; color: #a0a0a0; margin-bottom: 5px;">
                                    üéØ Next Steps: ${analysis.action_plan.next_steps?.slice(0, 1)[0]?.action || 'View details'}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function viewDetails(userId, thoughtId) {
            window.location.href = `detail.html?user_id=${userId}&thought_id=${thoughtId}`;
        }

        // SSE Connection Management
        function connectSSE() {
            if (isAnonymous) {
                // Anonymous users don't get SSE (no real-time processing anyway)
                return;
            }

            const userId = getUserId();
            if (!userId) return;

            const token = localStorage.getItem('auth_token');
            if (!token) return;

            // Close existing connection
            if (eventSource) {
                eventSource.close();
            }

            try {
                // Create SSE connection with auth token as query param
                // Note: EventSource doesn't support custom headers, so we use query param
                const url = `${API_BASE}/events/${userId}?token=${encodeURIComponent(token)}`;
                eventSource = new EventSource(url);

                eventSource.onopen = function() {
                    console.log('‚úÖ SSE Connected - Real-time updates enabled');
                    reconnectAttempts = 0;
                    
                    // Show connection indicator
                    showConnectionStatus('connected');
                };

                eventSource.addEventListener('connected', function(e) {
                    const data = JSON.parse(e.data);
                    console.log('SSE Connection confirmed:', data.message);
                });

                eventSource.addEventListener('thought_created', function(e) {
                    const data = JSON.parse(e.data);
                    console.log('üÜï New thought created:', data.thought_id);
                    
                    // Reload thoughts to show new one
                    loadThoughts();
                    
                    // Show toast notification
                    showToast('Thought created! Analysis will begin shortly.', 'info');
                });

                eventSource.addEventListener('thought_processing', function(e) {
                    const data = JSON.parse(e.data);
                    console.log('‚öôÔ∏è Thought processing:', data.thought_id);
                    
                    // Update thought status in UI
                    updateThoughtStatus(data.thought_id, 'processing', data.message);
                    
                    showToast('AI analysis started...', 'info');
                });

                eventSource.addEventListener('thought_agent_completed', function(e) {
                    const data = JSON.parse(e.data);
                    console.log(`‚úì Agent ${data.agent} completed (${data.progress})`);
                    
                    // Show progress
                    showToast(`${data.agent} completed (${data.progress})`, 'success');
                });

                eventSource.addEventListener('thought_completed', function(e) {
                    const data = JSON.parse(e.data);
                    console.log('‚úÖ Thought completed:', data.thought_id);
                    
                    // Reload thoughts to show analysis
                    loadThoughts();
                    
                    showToast('Analysis complete! View your insights.', 'success');
                });

                eventSource.addEventListener('thought_failed', function(e) {
                    const data = JSON.parse(e.data);
                    console.error('‚ùå Thought failed:', data.thought_id, data.error);
                    
                    // Reload thoughts
                    loadThoughts();
                    
                    showToast('Analysis failed. Please try again.', 'error');
                });

                eventSource.onerror = function(error) {
                    console.error('‚ùå SSE Connection error:', error);
                    showConnectionStatus('disconnected');
                    
                    // Attempt reconnection
                    eventSource.close();
                    
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                        console.log(`Reconnecting SSE in ${delay}ms (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                        
                        reconnectTimeout = setTimeout(() => {
                            connectSSE();
                        }, delay);
                    } else {
                        console.error('Max reconnection attempts reached. Falling back to polling.');
                        showToast('Real-time updates unavailable. Using refresh mode.', 'warning');
                        // Fallback to polling
                        setInterval(loadThoughts, 10000);
                    }
                };

            } catch (error) {
                console.error('Failed to create SSE connection:', error);
                // Fallback to polling
                setInterval(loadThoughts, 10000);
            }
        }

        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
        }

        function showConnectionStatus(status) {
            // Add a subtle indicator in the header
            let indicator = document.getElementById('connectionIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'connectionIndicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: 600;
                    z-index: 1000;
                    transition: all 0.3s ease;
                    backdrop-filter: blur(10px);
                `;
                document.body.appendChild(indicator);
            }

            if (status === 'connected') {
                indicator.style.background = 'rgba(52, 168, 83, 0.2)';
                indicator.style.border = '1px solid rgba(52, 168, 83, 0.5)';
                indicator.style.color = '#34a853';
                indicator.innerHTML = 'üü¢ Live Updates';
                // Hide after 3 seconds
                setTimeout(() => {
                    indicator.style.opacity = '0';
                }, 3000);
            } else {
                indicator.style.background = 'rgba(220, 53, 69, 0.2)';
                indicator.style.border = '1px solid rgba(220, 53, 69, 0.5)';
                indicator.style.color = '#dc3545';
                indicator.innerHTML = 'üî¥ Reconnecting...';
                indicator.style.opacity = '1';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                padding: 16px 24px;
                border-radius: 10px;
                font-size: 14px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease;
                backdrop-filter: blur(10px);
            `;

            const colors = {
                info: { bg: 'rgba(102, 126, 234, 0.2)', border: '#667eea', color: '#667eea' },
                success: { bg: 'rgba(52, 168, 83, 0.2)', border: '#34a853', color: '#34a853' },
                error: { bg: 'rgba(220, 53, 69, 0.2)', border: '#dc3545', color: '#dc3545' },
                warning: { bg: 'rgba(251, 191, 36, 0.2)', border: '#fbbf24', color: '#fbbf24' }
            };

            const style = colors[type] || colors.info;
            toast.style.background = style.bg;
            toast.style.border = `1px solid ${style.border}`;
            toast.style.color = style.color;
            toast.textContent = message;

            document.body.appendChild(toast);

            // Add animation
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(styleSheet);

            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function updateThoughtStatus(thoughtId, status, message) {
            // Update thought card status if visible
            const thoughtCard = document.querySelector(`[data-thought-id="${thoughtId}"]`);
            if (thoughtCard) {
                const statusBadge = thoughtCard.querySelector('.thought-status');
                if (statusBadge) {
                    statusBadge.className = `thought-status ${status}`;
                    statusBadge.textContent = status;
                }
            }
        }

        // Initialize - load thoughts and connect SSE
        loadThoughts();
        
        if (!isAnonymous) {
            // For authenticated users, connect SSE for real-time updates
            connectSSE();
        } else {
            // For anonymous users, poll every 15 seconds (they're not getting real-time processing anyway)
            setInterval(loadThoughts, 15000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            disconnectSSE();
        });
    </script>
</body>
</html>
